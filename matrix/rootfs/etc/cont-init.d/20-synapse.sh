#!/usr/bin/with-contenv bashio
# ==============================================================================
# Community Hass.io Add-ons: Matrix
# Configures the Matrix Synapse server
# ==============================================================================
declare server_name
server_name=$(bashio::config 'server_name')

if bashio::fs.file_exists "/config/matrix.yaml"; then
    declare old_name
    old_name=$(yq read /config/matrix.yaml 'server_name')
    if [[ "$old_name" != "$server_name" ]]; then
        bashio::log.fatal ''
        bashio::log.fatal 'The server_name has changed!'
        bashio::log.fatal 'Are you sure you want to do this?'
        bashio::log.fatal 'If so, delete the "matrix.yaml" file located in "/config" and restart the addon.'
        bashio::log.fatal 'WARNING: This will remove all rooms, users, chats and start afresh.'
        bashio::exit.nok
    fi
fi

if ! bashio::fs.file_exists "/config/matrix.yaml"; then
    bashio::log.info "Config file at '/config/matrix.yaml' does not exist. Creating.."

    rm -f /share/matrix/matrix.db

    python3.6 -m synapse.app.homeserver \
        --server-name "$server_name" \
        --config-path /data/matrix/matrix.yaml \
        --generate-config \
        --report-stats=no

    mv /data/matrix/matrix.yaml /config/matrix.yaml

    yq delete --inplace /config/matrix.yaml 'listeners[1]'
    yq write --inplace /config/matrix.yaml 'enable_registration' true
    yq write --inplace /config/matrix.yaml 'database.args.database' '/share/matrix/matrix.db'
    yq write --inplace /config/matrix.yaml 'media_store_path' '/share/matrix/media'
    yq write --inplace /config/matrix.yaml 'uploads_path' '/share/matrix/uploads'
    yq write --inplace /config/matrix.yaml 'max_upload_size' '200M'
fi

if bashio::config.true 'ssl'; then
    yq write --inplace /config/matrix.yaml 'no_tls' false
    yq write --inplace /config/matrix.yaml 'listeners[0].tls' true
    yq write --inplace /config/matrix.yaml 'tls_certificate_path' "/ssl/$(bashio::config 'certfile')"
    yq write --inplace /config/matrix.yaml 'tls_private_key_path' "/ssl/$(bashio::config 'keyfile')"
else
    yq write --inplace /config/matrix.yaml 'no_tls' true
    yq write --inplace /config/matrix.yaml 'listeners[0].tls' false
    # Synapse complains if there is not a certificate present even with no_tls set.
    # These are certificates obtained from lets encrypt generated by the above python command.
    yq write --inplace /config/matrix.yaml 'tls_certificate_path' "/data/matrix/$server_name.tls.crt"
    yq write --inplace /config/matrix.yaml 'tls_private_key_path' "/data/matrix/$server_name.tls.key"
fi

# Add warning to top of file
sed -i '1s/^/# Make sure you know what you are doing before editing this file!\n/' /config/matrix.yaml
sed -i '1s/^/# Be aware that this file contains options that could potentially break the add-on.\n/' /config/matrix.yaml
